---
title: "Case_Study_4_Code"
author: "Brian Gaither, Sean Mcwhirter, Andrew Mejia, Sabrina Purvis"
date: "`r Sys.time()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 6
  github_document:
    toc: yes
    toc_depth: 6
  word_document:
    toc: yes
    toc_depth: '6'
always_allow_html: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(hms)
library(rvest)
library(lubridate)
library(foreach)
library(stringr)
library(iterators)
library(progress)
library(doParallel)
library(doSNOW)
library(dplyr)
```

```{r}
years = c(1999:2012)
division = 'Overall+Women'
section = '10M' 
sex = 'W'
```

#### Functions

#The gen_Link function will generates the link with the query parameters for the searchable database

```{r}
gen_Link = function(year,division,section,page=1,sex){

  paste0( 'http://www.cballtimeresults.org/performances'
          ,'?division=',division,'&page=',page,
          '&section=',section, '&sex=',sex, 
          '&utf8=%E2%9C%93','&year=',year)
          #,'?utf8=%E2%9C%93&section=',section
          #,'&year=',year,'&division=',division,'&page=', page)

}

```

# The gen_Table function will parse through the table of 20 records and 15 observations
# and parse the table into its own data frame from xml2 read)html function and then use 
# the pipe operator to use rvest nodes to find the table structure 
# then the fucntion will insert the metadata for the query parameters of year, division, section, page, source link and sex 
```{r}
gen_Table = function(year,division,section,page, sex){
  
  
  #use gen_link function to get link to page 
  genlink=gen_Link(year,division,section,page=page, sex=sex)
  
  #read the page, and grab to 'table' tag
  single_table = xml2::read_html(genlink) %>% 
    rvest::html_nodes("table")  %>% 
    rvest::html_table(fill=TRUE) 
  
  #get the table and add metadata for the query parameters
  table_out = single_table[[1]] %>% 
    mutate(year=year, divisionTitle=division, section=section, page=page, source=genlink, sex = sex)
  
}

```

# This function will use all available cores on machine
# It will process the years in parrell. 
```{r}
# This code has been adapted from 
# https://github.com/ngupta23/ds7333_qtw/blob/master/case_study_2/submission_Kannan_Moro_Gupta/code/CS2_ETL.Rmd 
# https://cran.r-project.org/web/packages/doSNOW/doSNOW.pdf
# https://stackoverflow.com/questions/36794063/r-foreach-from-single-machine-to-cluster
# https://cran.r-project.org/web/packages/progress/progress.pdf
# https://www.r-bloggers.com/2013/08/the-wonders-of-foreach/
```


```{r}
scrapeTables  = function(years,division,section, sex,  max_itr = 500){
  
  
library(progress)
library(doParallel)
library(doSNOW)  
  
    #Initialize Parrellel Process to detect number of cores 
    #https://cran.r-project.org/web/packages/doSNOW/doSNOW.pdf
    #https://stackoverflow.com/questions/36794063/r-foreach-from-single-machine-to-cluster
  
    #Generate and register initial clusters based on cores, otherwise, this is a long process 
    cl = makeCluster(detectCores())
    doSNOW::registerDoSNOW(cl)
    
    #Generate progress bar for the parallel loop based on number of years 
    #https://cran.r-project.org/web/packages/progress/progress.pdf
    progBar = progress::progress_bar$new(total = length(years),format='[:bar] :percent :eta')
    progress = function(n) progBar$tick()
    
    #Initialize a parallel loop per each year
    #Intialize tableRaw as empty to loop to be populated as a table dataframe from gen_Table function
    tableRaw=NULL
    
    #tableRaw will now use for each using years as the iterator to use .combine to rbind
    #.export will do the gen_Table and gen_Link functions simultanlously and 
    #options.snow will show the progress bar
    # the %dopar% will process all the years simultaneously. 
    #https://www.r-bloggers.com/2013/08/the-wonders-of-foreach/
    tableRaw = foreach(y=years
                      ,.combine=rbind,.export=c('gen_Table','gen_Link')
                      ,.options.snow = list(progress=progress)) %dopar%
      {
        
        library(foreach)
        library(dplyr)
        #intialize isCompleted variable as FALSE for bool conditions to see if loop has been completed
        isCompleted=FALSE
        
        #Initiate loop since most pages are 487, we will only loop for the iterations for max_itr
        tableRaw=foreach(p=c(1:max_itr),.combine=rbind) %do% 
          if(!isCompleted) {
            message('getting year:',y, ' page:',p,appendLF = F)
            #get the table of the current page
            table = gen_Table(year=y
                             ,division=division
                             ,section=section
                             ,page=p
                             ,sex=sex)
            message(' rows:',nrow(table))
            isCompleted = nrow(table)==0 #if there is record, we are at the last page, no need to read further
            return(table)
          }
        return(tableRaw)
      }
    #Deactivate the cluster of cores
    stopCluster(cl)
    #save the raw data to rda format for later processing based on gender
    saveRDS(tableRaw,file=paste0('CB',sex,'tableRaw.rda'))
    
  return(tableRaw)
}
  
 
```


```{r}
Women_table = scrapeTables(years=years,division = division,section=section,sex = sex, max_itr = 500)
```

```{r}
Women_table
```

```{r}
load(file = "C:/Users/seans/Desktop/CBWomenTextTables.rda") 
```

```{r}
w_tables = dataRaw
```


```{r}
w_tables
```

```{r}
#time and pace to decimal form (time is in hours)
#https://itqna.net/questions/98223/how-convert-hour-minutes-seconds-decimal-number-r

library(lubridate)

#time
time_calc <- hms(w_tables$Time)
time_calc2 = hour(time_calc) + (minute(time_calc)/60) + (second(time_calc)/3600)
w_tables$Time <- time_calc2
```

```{r}

#pace (in MPH)
pace_calc <- ms(w_tables$Pace)
pace_calc2 = 60/(minute(pace_calc) + (second(pace_calc)/60))
w_tables$Pace <- pace_calc2
```


```{r}
#check
#w_tables
```


```{r}
#replace 'NR' with NA
#https://cran.r-project.org/web/packages/naniar/vignettes/replace-with-na.html

library(naniar)
w_tables <- w_tables %>% replace_with_na(replace = list(Division = "NR"))
w_tables <- w_tables %>% replace_with_na(replace = list("PiS/TiS" = "NR"))
w_tables <- w_tables %>% replace_with_na(replace = list("PiD/TiD" = "NR"))
w_tables <- w_tables %>% replace_with_na(replace = list("Hometown" = "NR"))


```


```{r}
#check
#w_tables
```

```{r}
#Change columns to numeric or factor
w_tables$Age <- as.numeric(as.character(w_tables$Age))
w_tables$Division <- as.factor(as.character(w_tables$Division))
w_tables$year <- as.factor(as.character(w_tables$year)) #year needs to be changed to a factor for graphing

```

```{r}
#check
w_tables
```



```{r}
#Check for missing values
sapply(w_tables, function(x) sum(is.na(x)))
```


We have plenty of dat if we drop all of the "NA's"

```{r}
#Drop NA's
w_tables_final <- na.omit(w_tables)

```

```{r}
#final check pre-EDA
w_tables_final
sapply(w_tables_final, function(x) sum(is.na(x)))
```


```{r}
library(ggplot2)
library(ggthemes)

#Age by year
ggplot(data = w_tables_final, mapping = aes(x = year, y = Age)) +
      geom_jitter(alpha = 0.3, color = "tomato") + geom_boxplot(alpha = 0) + theme_economist() + labs(title = "Female Age by Year")
```


```{r}
#Pace by year
ggplot(data = w_tables_final, mapping = aes(x = year, y = Pace)) +
      geom_jitter(alpha = 0.3, color = "tomato") + geom_boxplot(alpha = 0) + theme_economist() + labs(title = "Female Pace by Year")
```


```{r}
#Time by year
ggplot(data = w_tables_final, mapping = aes(x = year, y = Time)) +
      geom_jitter(alpha = 0.3, color = "tomato") + geom_boxplot(alpha = 0) + theme_economist() + labs(title = "Female Time by Year")
```



```{r}
#Age by year
#https://stackoverflow.com/questions/14623348/how-to-use-facet-to-create-multiple-density-plot-in-ggplot
ggplot(data=w_tables_final, aes(x=Age)) + geom_density(aes(fill=year), alpha=0.4)+  labs(title = "Female Age Distributions by Year") 

```

```{r}
#Pace by year
ggplot(data=w_tables_final, aes(x=Pace)) + geom_density(aes(fill=year), alpha=0.4)+ labs(title = "Female Pace Distributions by Year")

```

```{r}
#Pace by year
ggplot(data=w_tables_final, aes(x=Time)) + geom_density(aes(fill=year), alpha=0.4) + labs(title = "Female Time by Year")

```

```{r}
#Division count by year
ggplot(w_tables_final, aes(Division)) + geom_bar() + facet_wrap(~year) + theme(axis.text = element_text(angle = 90, vjust = .05, hjust=1))

```



```{r}
#Participation by year
#https://stackoverflow.com/questions/26114525/how-to-count-how-many-values-per-level-in-a-given-factor

library(dplyr)
w_tables_final %>% group_by(year) %>% summarize(cnt = Name) %>% ggplot(aes(x = year)) + geom_bar(fill = 'springgreen4') + labs(title = "Participation by Year")

```































```{r}
library(purrr)

#Automated EDA
# step 1, save target variable name

target <- "Time"
# step 2, save explanator variable names
numvars <- w_tables_final %>% keep(is.numeric) %>% colnames


numplot <- function(df, explan, resp) {
  ggplot(data = df) + geom_density(aes_string(x = explan, fill = resp), alpha = 0.5)
}

numplot(w_tables_final, explan = "Age", resp = "Time")
numplot(w_tables_final, explan = "Age", resp = "Time")

plotlist <- lapply(numvars, function(x) numplot(w_tables_final, x, "Time"))


png()
lapply(numvars, function(x) numplot(w_tables_final, x, "Time"))
dev.off()

library(cowplot)
plot_grid(plotlist = plotlist)


# categorical vs categorical
ggplot(data = w_tables_final) + geom_bar(aes(x = Age, fill = Time), position = "fill", alpha = 0.9) + coord_flip()


ones <- rep(1, nrow(w_tables_final))
zeroes <- rep(0, nrow(w_tables_final))
onezeroes <- c(ones, zeroes)

w_tables_final$rcat <- sample(onezeroes, nrow(w_tables_final))


ggplot(data = w_tables_final) + geom_bar(aes(x = Age, fill = Time), position = "fill", alpha = 0.9) + coord_flip()

# step 1: Name target variable:

target <- "Time"

# step 2: name explanatory vars

expls <- w_tables_final %>% keep(is.factor) %>% colnames


catplot <- function(df, x,y){
  ggplot(data = df, aes_string(x = x, fill = y)) + 
    geom_bar(position = "fill", alpha = 0.9) + 
    coord_flip()
}


plotlist2 <- lapply(expls, function(x) catplot(w_tables_final, x, target))
plot_grid(plotlist = plotlist2)
```













