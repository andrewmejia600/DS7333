---
title: "Cherry Blossom"
author: "Sabrina Purvis"
date: "1/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Planning considerations:
 - Parking accommodations
 - Hotel reservations/pricing packages
 - Race day support like Police, volunteers, space to physically queue up the racers to start the race
 - SWAG and timing chip orders
 - SWAG and bib/chip distribution
 - Logistics to transition to a virtual race (Do we want to consider this piece?) around shipping everything

```{r}
#Libraries
library(tidyverse)
library(ggplot2)
library(plotly)
library(RColorBrewer)
library(chron)
library(lubridate)
library(hrbrthemes)
library(viridis)
```

```{r cars}
CBWtableRaw <- readRDS("C:/Users/sabri/Downloads/CBWtableRaw.rds")
head(CBWtableRaw)
```
```{r}
str(CBWtableRaw)
```
Note above I see an NR, not a na, nan or other blank.  Will need to factor with NR

```{r}
noresults = CBWtableRaw %>% dplyr::filter(Division == "NR")
dim(noresults)
head(noresults)
```

```{r eval=FALSE, include=FALSE}
noresults = CBWtableRaw %>% dplyr::filter(Age == "NR")
dim(noage)
head(noage)
```


```{r}
# Remove no results
data = CBWtableRaw %>% 
  dplyr::filter(Division != "NR")
```

convert race year to factor
```{r}
#looking at race year
# Participants by Year
plotdata = CBWtableRaw %>% 
  group_by(year) %>% 
  summarise(count=n()) 

p = plotdata %>% 
  ggplot(aes(x=year, y=count)) +
  geom_line() +
  geom_point()
ggplotly(p)

p = plotdata %>% 
  ggplot(aes(x = year, y = count)) + 
  geom_bar(stat = "identity", fill = "blue")
ggplotly(p) 
```

```{r}
# looking at counts with division splits too
plotdata = CBWtableRaw %>% 
  group_by(year, Division) %>% 
  summarise(count = n())

p = plotdata %>% 
  ggplot(aes(x = year, y = count, fill = Division)) + 
  geom_bar(stat = "identity", position = "stack") 
ggplotly(p)

```


```{r}
plotdata_by_year = CBWtableRaw %>% 
  group_by(year) %>% 
  summarise(count_year = n())

colourCount = length(unique(CBWtableRaw$Division))
getPalette = colorRampPalette(brewer.pal(9, "Paired"))

plotdata_by_year_div = CBWtableRaw %>% 
  group_by(year, Division) %>% 
  summarise(count_year_div = n())
plotdata = plotdata_by_year %>% 
  plyr::join(plotdata_by_year_div, by = "year", type = "full") %>% 
  mutate(percent = round(count_year_div/count_year*100,1))
  
p = plotdata %>% 
  ggplot(aes(x = year, y = percent, fill = Division)) + 
  geom_bar(stat = "identity", position = "stack") +  scale_fill_manual(values = getPalette(colourCount)) +
  theme(legend.position="bottom") +
  guides(fill=guide_legend(nrow=2))

ggplotly(p) 
```
```{r}
#heatmap on the distribution - are they getting any younger?

p = plotdata %>% 
  ggplot(aes(x = year, y = Division, fill = percent )) + 
  geom_tile(alpha=.5) + scale_fill_viridis()
ggplotly(p) 

```



convert time to minutes
```{r}
noresults = CBWtableRaw %>% dplyr::filter(Time == "NR")
dim(noresults)
head(noresults)
tail(CBWtableRaw)
```


```{r}
CBWtableRaw$Time <- chron(times=CBWtableRaw$Time) #formatting the character string for time to HH:MM:SS
sum(is.na(CBWtableRaw$Time))

res <- hms(CBWtableRaw$Time)        # Identifying Hours, Minutes, Seconds
CBWtableRaw$Time = hour(res)*60 + minute(res) + second(res)/60       # convert hours to minutes, add minutes, and convert seconds to minutes and add
```



```{r}

plotdata = CBWtableRaw %>% 
  group_by(year, Division) %>% 
  summarise(count = n())

colourCount = length(unique(CBWtableRaw$Division))
getPalette = colorRampPalette(brewer.pal(9, "Paired"))

p = plotdata %>% 
  ggplot(aes(x = year, y=count, group = year, fill = Division)) + 
 geom_bar(stat = "identity") + facet_wrap(~Division) + scale_fill_manual(values = getPalette(colourCount)) +
  theme(legend.position="bottom") +
  guides(fill=guide_legend(nrow=2))
ggplotly(p, tooltip="text") 


p = plotdata %>% 
  ggplot(aes(x = year, y=count, group = year, fill = Division)) + 
 geom_bar(stat = "identity") + facet_wrap(~Division, scales = "free") + scale_fill_manual(values = getPalette(colourCount)) +
  theme(legend.position="bottom") +
  guides(fill=guide_legend(nrow=2))
ggplotly(p, tooltip="text") 
```
boxplots for medians by year
```{r}
p =  CBWtableRaw %>% 
      ggplot(aes(x = year, y = Time, group = year, color = year)) + 
     geom_boxplot()

ggplotly(p, tooltip="text") 
```
looking at median time by division
```{r}
p = CBWtableRaw %>% 
      ggplot(aes(x = year, y = Time, group = year, color = year)) + 
     geom_boxplot() + facet_wrap(~Division)
ggplotly(p, tooltip="text") 
```

```{r}
#predict LM


#Predict LOESS on time
plot(Time~year, ylim = c(94,100), data=CBWtableRaw, main="Year V Time")
out <- loess(Time~year, data=CBWtableRaw)
curve(predict(out, newdata=data.frame(year = x)), add=TRUE)
```

Run a piecewise fit next


evaluate city/state impact for recommendations for planning
```{r}
#split out city and state to see in town/out of town distribution
library(dplyr)
library(tidyr)

#before <- CBWtableRaw

#unlist(strsplit(before$Hometown, "[, ]"))##Not working
#head(before, 10)

```

